<html>
    <head>
        <title>RegistrarCuento</title>
    </head>
    <body>
        <style>img{height: 200px;width: 200px;border: 2px solid black;}</style>
        Titulo<input id="titulobox" type="text"> <br><br>
        Contenido<input id="contenidobox" type="text"> <br><br>
        Image Name<input id="namebox" type="text"> <br><br>
        <!---Categoria <input id="categoriabox" type="text"> -->
        Categoria
        <select name="combobox" id="list"><br><br>
            <option value="Fantasia">Fantasia</option>
            <option value="Fabulas">Fabulas</option>
            <option value="Clasicos">Clasicos</option>
        </select> <br><br>
        <img id="myimg"> <label id="UpProgress"></label> <br><br>

        <button id="select">Select</button>
        <button id="upload">Upload</button>
        <button id="retrieve">retrieve</button>

<!-----------FIREBASE LIBRARIES--------------->
<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-auth.js"></script> 
<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-database.js"></script> 
<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-storage.js"></script>
<script src="https://www.gstatic.com/firebasejs/7.15.1/firebase-firestore.js"></script>

<script id="MainScript">
    //-----------VARIABLES------------//
    var ImgName, ImgUrl, Categoria, TituloCuento, ContenidoCuento;
    var files = [];
    var reader;
    //--------------CONFIG------//
    var firebaseConfig = {
        apiKey: "AIzaSyAbFC7FyNe9t8VBGO8xXPu-XtFSWeuo2i0",
      authDomain: "colorin-colorado-f857f.firebaseapp.com",
      databaseURL: "https://colorin-colorado-f857f-default-rtdb.firebaseio.com",
      projectId: "colorin-colorado-f857f",
      storageBucket: "colorin-colorado-f857f.appspot.com",
      messagingSenderId: "31331535773",
      appId: "1:31331535773:web:55d57a73caeb602085bd74",
      measurementId: "G-37YPHDXTPN"
    };
    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    //---------------selection --------------//
    document.getElementById("select").onclick = function(e){
        var input = document.createElement('input');
        input.type='file';

        input.onchange = e =>{
            files = e.target.files;
            reader  = new FileReader();
            reader.onload = function(){
                document.getElementById("myimg").src = reader.result;
            }
            reader.readAsDataURL(files[0]);

        }
        input.click();
    }
    //---------------UPLOAD----------------//
     //---------------subir al storage----------------//
    document.getElementById('upload').onclick = function(){
        TituloCuento = document.getElementById('titulobox').value;
        ContenidoCuento = document.getElementById('contenidobox').value;
        ImgName = document.getElementById('namebox').value;
        Categoria = document.getElementById("list").value;

        var uploadTask = firebase.storage().ref('Images/'+ImgName+".png").put(files[0]);

        uploadTask.on('state_changed',function(snapshot){
            var progress = (snapshot.bytesTranferred / snapshot.totalBytes)*100;
            document.getElementById('UpProgress').innerHTML = 'Upload'+progress+'%';
        },
     //---------------por si hay error----------------//
        function(error){
            alert('error al guardar');
        },
     //---------------guardar el link de la imagen en database----------------//
        function(){
            uploadTask.snapshot.ref.getDownloadURL().then(function(url){
                ImgUrl = url;
                const db = firebase.firestore();
                const response = db.collection('Prueba').doc().set({TituloCuento,ContenidoCuento,ImgName,Categoria,ImgUrl});
                /*
                firebase.database().ref(Categoria+'/'+ImgName).set({
                    Titulo: TituloCuento,
                    NameImagen: ImgName,
                    Link: ImgUrl,
                    Contenido: ContenidoCuento
                });*/
                alert('imagen a√±adida');
            }
        );
    });
    }
    //---------------recuperar la imagen de database----------------//
    document.getElementById('retrieve').onclick = function(){
        ImgName = document.getElementById('namebox').value;
        firebase.database().ref('Pictures/'+ImgName).on('value',function(snapshot){
            document.getElementById('myimg').src = snapshot.val().Link;
        });
    }
</script>

    </body>
</html>